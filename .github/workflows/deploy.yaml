name: build and deploy

on: [push] 
jobs:
  ci: 
    environment:
      name: Testing 

    env: 
    #   DATABASE_HOSTNAME:
    #   DATABASE_PORT:
    #   DATABASE_NAME: 
    #   DATABASE_PASSWORD:
    #   DATABASE_USERNAME:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}

    # # not making queries to database yet 

    # services: 
    #   postgres: 
    #     image: postgres

    #     env: 
    #       POSTGRES_PASSWORD: ${{secrets.DATABASE_PASSWORD}}
    #       POSTGRES_DB: ${{secrets.DATABASE_NAME}}_test 

    #     ports: 
    #       - 5432:5432

    #     options: >- 
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5
    

    runs-on: ubuntu-latest  
    steps: 
      - name: pull git repo
        uses: actions/checkout@v4
      
      - name: setup python 
        uses: actions/setup-python@v4
        with: 
          python-version: "3.9" 

      - name: upgrade pip 
        run: python -m pip install --upgrade pip 

      - name: install dependencies
        run: pip install -r requirements.txt 

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
  
  cd: 
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - uses: JorgeLNJunior/render-deploy@v1.4.5
        with:
          service_id: ${{ secrets.RENDER_SERVICE_ID }}
          api_key: ${{ secrets.RENDER_API_KEY }}

